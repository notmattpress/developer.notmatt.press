
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled Page</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.5/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: white;
            color: black;
            font-family: 'Quicksand', 'Open Sans', 'Helvetica', 'Arial', san-serif;
        }
        a, h1, h2, h3, h4, h5, h6 {
            color: #0073aa;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }
        .has-small-font-size.is-link-to-top {
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
        .entry-content {
            position:relative;
        }
        .entry-content img {
            max-width: 100%;
        }
    </style>
</head>
<body>
<div class='container'>
    
    <div class="page-metadata" data-published="" data-last-updated=""></div>
    
    <div aria-label="Breadcrumbs" class="wp-block-wporg-site-breadcrumbs has-small-font-size" role="navigation"><div class="wporg-site-breadcrumbs__wrapper"><span><a href="https://developer.wordpress.org">Home</a></span><span><a href="https://developer.wordpress.org/reference/">Reference</a></span><span><a href="https://developer.wordpress.org/reference/functions/">Functions</a></span><span class="is-current-page">serialize_blocks()</span></div></div>  <!-- Full breadcrumbs HTML -->
    <h1>serialize_blocks()</h1>
    <h1 class="wp-block-wporg-code-reference-title" style="margin-bottom:40px;">serialize_blocks( <span class="arg-type">array[]</span> <span class="arg-name">$blocks</span> ): <span class="return-type">string</span></h1>
    
    <div class="content"><div class="entry-content wp-block-post-content is-layout-flow wp-container-core-post-content-is-layout-1 wp-block-post-content-is-layout-flow">
<section class="wp-block-wporg-code-reference-summary"><p>Returns a joined string of the aggregate serialization of the given parsed blocks.</p>
</section>
<section class="wp-block-wporg-code-reference-parameters"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="parameters" tabindex="-1"><a href="#parameters">Parameters</a></h2> <dl><dt><code>$blocks</code><span class="type"><span class="array[]">array[]</span></span><span class="required">required</span></dt><dd><div class="desc"><span class="description">Array of block structures.<br/>
<ul class="param-hash"><li><code>...$0</code> <span class="type">array</span><div class="desc"> An associative array of a single parsed block object. See <a href="https://developer.notmatt.press/reference/classes/wp_block_parser_block/" rel="class">WP_Block_Parser_Block</a>.<ul class="param-hash">
<li><code>blockName</code> <span class="type">string</span><div class="desc">Name of block.</div></li>
<li><code>attrs</code> <span class="type">array</span><div class="desc">Attributes from block comment delimiters.</div></li>
<li><code>innerBlocks</code> <span class="type">array[]</span><div class="desc">List of inner blocks. An array of arrays that have the same structure as this one.</div></li>
<li><code>innerHTML</code> <span class="type">string</span><div class="desc">HTML from inside block comment delimiters.</div></li>
<li><code>innerContent</code> <span class="type">array</span><div class="desc">List of string fragments and null markers where inner blocks were found.<br/>
</div></li></ul>
</div></li>
</ul>
</span></div></dd></dl></section>
<section class="wporg-has-embedded-code wp-block-wporg-code-reference-return-value"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="return" tabindex="-1"><a href="#return">Return</a></h2> <span class="return-type">string</span> String of rendered HTML.</section>
<section class="wp-block-wporg-code-reference-source"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="source" tabindex="-1"><a href="#source">Source</a></h2> <pre aria-label="Function source code" class="wp-block-code" data-start="1562"><code class="language-php line-numbers" id="wporg-source-code" lang="php">function serialize_blocks( $blocks ) {
	return implode( '', array_map( 'serialize_block', $blocks ) );
}
</code></pre><p class="wporg-dot-link-list"><a href="https://developer.notmatt.press/reference/files/wp-includes/blocks.php/">View all references</a> <a href="https://core.trac.wordpress.org/browser/tags/6.7/src/wp-includes/blocks.php#L1562">View on Trac</a> <a href="https://github.com/WordPress/wordpress-develop/blob/6.7/src/wp-includes/blocks.php#L1562-L1564">View on GitHub</a></p></section>
<section class="wp-block-wporg-code-reference-related" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="related" tabindex="-1"><a href="#related">Related</a></h2> <section class="wp-block-wporg-code-table" id="used-by" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Used by</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/classes/wp_classic_to_block_menu_converter/convert/">WP_Classic_To_Block_Menu_Converter::convert()</a><code>wp-includes/class-wp-classic-to-block-menu-converter.php</code></td><td><p>Converts a Classic Menu to blocks.</p>
</td></tr><tr class=""><td><a href="https://developer.notmatt.press/reference/classes/wp_rest_block_patterns_controller/prepare_item_for_response/">WP_REST_Block_Patterns_Controller::prepare_item_for_response()</a><code>wp-includes/rest-api/endpoints/class-wp-rest-block-patterns-controller.php</code></td><td><p>Prepare a raw block pattern before it gets output in a REST API response.</p>
</td></tr><tr class=""><td><a href="https://developer.notmatt.press/reference/classes/wp_rest_templates_controller/prepare_item_for_response/">WP_REST_Templates_Controller::prepare_item_for_response()</a><code>wp-includes/rest-api/endpoints/class-wp-rest-templates-controller.php</code></td><td><p>Prepare a single template output for response</p>
</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-changelog"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="changelog" tabindex="-1"><a href="#changelog">Changelog</a></h2> <section class="wp-block-wporg-code-table" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Version</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/since/5.3.1/">5.3.1</a></td><td>Introduced.</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-comments" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading" id="user-contributed-notes" tabindex="-1"><a href="#user-contributed-notes">User Contributed Notes</a></h2> <ol class="comment-list"> <li class="comment byuser comment-author-si3ard odd alt thread-odd thread-alt depth-1" data-comment-id="4974" id="comment-4974">
<article class="comment-body" id="div-comment-4974">
<a class="screen-reader-text" href="#comment-content-4974">Skip to note 2 content</a>

<!-- .comment-metadata -->
<div class="wporg-has-embedded-code comment-content" id="comment-content-4974">
<p><strong>Used with <code>wp_update_post()</code></strong></p>
<p>Sample of how to use <code>serialize_blocks()</code> after making adjustments to a post’s block content.</p>
<p>In this use case, I wanted to create a cross-reference between the captions used on media in a gallery, and the captions saved to the media’s corresponding Attachment post.  These can easily get out of date if a user is only managing them in one place or the other.</p>
<pre class="wp-block-code"><code class="language-php line-numbers" lang="php">class WPDocs_Gallery_Caption_Demo {

	// Property used for storing attachment captions
	// that need to be added to gallery block content
	private $_missingBlockCaptions;

	function __construct() {

		add_action( 'save_post', array( $this, 'filterGalleries' ), 10, 2 );

	}

	public function filterGalleries( $post_id, $post ) {

		// Reset this property on each save.
		$this-&gt;_missingBlockCaptions = [];

		// Fetch parsed blocks from the post's saved content
		$blocks = parse_blocks( $post-&gt;post_content );

		// Check for missing captions if a Gallery Block is used on the page.
		// Also pass along the index of the block for use in editing content later
		foreach ( $blocks as $i =&gt; $block ) {

			if ( 'core/gallery' === $block['blockName'] ) {

				$this-&gt;_checkCaptions( $post, $block, $i );

			}

		}

	}

	private function _checkCaptions( $post, $block, $blockIndex ) {

		foreach ( $block['attrs']['ids'] as $attachmentID ) {

			$pattern        = sprintf( '/wp-image-%s"/&gt;&lt;figcaption[^&gt;]+&gt;(?&lt;caption&gt;[^&lt;]+)&lt;/figcaption/', $attachmentID );
			$savedCaption   = wp_get_attachment_caption( $attachmentID );
			$galleryCaption = preg_match_all( $pattern, $block['innerHTML'], $matches );

			// First check if the Gallery has a caption but the Attachment doesn't,
			// then check if the Attachent has a caption but the Gallery doesn't.
			if ( empty( $savedCaption ) &amp;&amp; $galleryCaption ) {

				// Immediately update the attachment's missing caption.
				$this-&gt;_updateAttachmentCaption( $attachmentID, $matches['caption'][0] );

			} elseif ( ! empty( $savedCaption ) &amp;&amp; ! $galleryCaption ) {

				// Store the block index, attachment ID and caption
				// for use later when we bulk-update the post content.
				$this-&gt;_missingBlockCaptions[ $blockIndex ][ $attachmentID ] = $savedCaption;

			}

		}

		// Use a bulk method to update multiple missing captions in the post content
		// for the Attachments that have a caption in their `post_excerpt` value,
		// since this is one `post_content` value for multiple media attachments.
		if ( ! empty( $this-&gt;_missingBlockCaptions ) ) {
			$this-&gt;_addBlockCaptions( $post );
		}

	}

	private function _updateAttachmentCaption( $attachmentID, $caption ) {

		wp_update_post( array(
			'ID'            =&gt; $attachmentID,
			'post_excerpt'  =&gt; $caption
		) );

	}

	private function _addBlockCaptions( $post ) {

		// Parse out the blocks so we can update the `innerContent`
		// for the corresponding indices stored $missingBlockCaptions.
		$blocks = parse_blocks( $post-&gt;post_content );

		foreach ( $this-&gt;_missingBlockCaptions as $blockIndex =&gt; $missingCaptions ) {

			foreach ( $misingCaptions as $attachmentID =&gt; $caption ) {

				// Match the end of the target img tag using its saved ID.
				$pattern = sprintf( '/(wp-image-%s"/&gt;)/', $attachmentID );

				// Add the missing figcaption markup, using the saved caption
				// from the Attachment's `post_excerpt` value we got in $this-&gt;checkCaptions()
				$replace = sprintf( '$1&lt;figcaption class="blocks-gallery-item__caption"&gt;%s&lt;/figcaption&gt;', $caption );

				// Insert our new figcaption markup into the target block
				// using the $blockIndex reference.
				$blocks[ $blockIndex ]['innerContent'][0] = preg_replace( $pattern, $replace, $blocks[ $blockIndex ]['innerContent'][0] );

			}

		}

		// Using `serialize_blocks` will handle `serialize_block`
		// for each block in $blocks.
		$content = serialize_blocks( $blocks );
		$updatedPost = array(
			'ID'            =&gt; $post-&gt;ID,
			'post_content'  =&gt; $content
		);

		// Update the post with the new adjustments made to the gallery blocks' `innerContent`
		wp_update_post( $updatedPost );

	}

}

new WPDocs_Gallery_Caption_Demo();</code></pre>
<p>Gallery blocks have a caption field on the block editor view that is static to the block and does not save back to the original Attachment.  This class updates the Attachment’s caption if it is empty while a static one was written in the a gallery block.  It also does the converse; it adds a <code></code> tag with the Attachment’s caption value to the gallery items that don’t have a static caption written on them.</p>
<p>The functional use for this is to update the captions into the database so that the user will see them on page reload, instead of trusting that they will show up only in the front end (using the <code>render_block</code> filter).</p>
</div><!-- .comment-content -->
<section class="wporg-has-embedded-code feedback hide-if-js" data-comment-count="0" id="feedback-4974">
</section><!-- .feedback -->

</article><!-- .comment-body -->
</li>
</ol></section>
</div></div>
    </div>
<footer class="text-center mt-10 py-5">
    <p class="text-sm"><a href="https://notmatt.press">NotMattPress</a>.</p>
</footer>
</body>
</html>
