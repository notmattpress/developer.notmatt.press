
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled Page</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.5/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: white;
            color: black;
            font-family: 'Quicksand', 'Open Sans', 'Helvetica', 'Arial', san-serif;
        }
        a, h1, h2, h3, h4, h5, h6 {
            color: #0073aa;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }
        .has-small-font-size.is-link-to-top {
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
        .entry-content {
            position:relative;
        }
        .entry-content img {
            max-width: 100%;
        }
    </style>
</head>
<body>
<div class='container'>
    
    <div class="page-metadata" data-published="" data-last-updated=""></div>
    
    <div aria-label="Breadcrumbs" class="wp-block-wporg-site-breadcrumbs has-small-font-size" role="navigation"><div class="wporg-site-breadcrumbs__wrapper"><span><a href="https://developer.wordpress.org">Home</a></span><span><a href="https://developer.wordpress.org/reference/">Reference</a></span><span><a href="https://developer.wordpress.org/reference/functions/">Functions</a></span><span class="is-current-page">register_deactivation_hook()</span></div></div>  <!-- Full breadcrumbs HTML -->
    <h1>register_deactivation_hook()</h1>
    <h1 class="wp-block-wporg-code-reference-title" style="margin-bottom:40px;">register_deactivation_hook( <span class="arg-type">string</span> <span class="arg-name">$file</span>,  <span class="arg-type">callable</span> <span class="arg-name">$callback</span> )</h1>
    
    <div class="content"><div class="entry-content wp-block-post-content is-layout-flow wp-container-core-post-content-is-layout-1 wp-block-post-content-is-layout-flow">
<section class="wp-block-wporg-code-reference-summary"><p>Sets the deactivation hook for a plugin.</p>
</section>
<section class="wp-block-wporg-code-reference-description"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="description" tabindex="-1"><a href="#description">Description</a></h2> <p>When a plugin is deactivated, the action ‘deactivate_PLUGINNAME’ hook is called. In the name of this hook, PLUGINNAME is replaced with the name of the plugin, including the optional subdirectory. For example, when the plugin is located in wp-content/plugins/sampleplugin/sample.php, then the name of this hook will become ‘deactivate_sampleplugin/sample.php’.</p>
<p>When the plugin consists of only one file and is (as by default) located at wp-content/plugins/sample.php the name of this hook will be ‘deactivate_sample.php’.</p>
</section>
<section class="wp-block-wporg-code-reference-parameters"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="parameters" tabindex="-1"><a href="#parameters">Parameters</a></h2> <dl><dt><code>$file</code><span class="type"><span class="string">string</span></span><span class="required">required</span></dt><dd><div class="desc"><span class="description">The filename of the plugin including the path.</span></div></dd><dt><code>$callback</code><span class="type"><span class="callable">callable</span></span><span class="required">required</span></dt><dd><div class="desc"><span class="description">The function hooked to the <code>'deactivate_PLUGIN'</code> action.</span></div></dd></dl></section>
<section class="wp-block-wporg-code-reference-source"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="source" tabindex="-1"><a href="#source">Source</a></h2> <pre aria-label="Function source code" class="wp-block-code" data-start="892"><code class="language-php line-numbers" id="wporg-source-code" lang="php">function register_deactivation_hook( $file, $callback ) {
	$file = plugin_basename( $file );
	add_action( 'deactivate_' . $file, $callback );
}
</code></pre><p class="wporg-dot-link-list"><a href="https://developer.notmatt.press/reference/files/wp-includes/plugin.php/">View all references</a> <a href="https://core.trac.wordpress.org/browser/tags/6.7/src/wp-includes/plugin.php#L892">View on Trac</a> <a href="https://github.com/WordPress/wordpress-develop/blob/6.7/src/wp-includes/plugin.php#L892-L895">View on GitHub</a></p></section>
<section class="wp-block-wporg-code-reference-related" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="related" tabindex="-1"><a href="#related">Related</a></h2> <section class="wp-block-wporg-code-table" id="uses" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Uses</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/functions/plugin_basename/">plugin_basename()</a><code>wp-includes/plugin.php</code></td><td><p>Gets the basename of a plugin.</p>
</td></tr><tr class=""><td><a href="https://developer.notmatt.press/reference/functions/add_action/">add_action()</a><code>wp-includes/plugin.php</code></td><td><p>Adds a callback function to an action hook.</p>
</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-changelog"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="changelog" tabindex="-1"><a href="#changelog">Changelog</a></h2> <section class="wp-block-wporg-code-table" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Version</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/since/2.0.0/">2.0.0</a></td><td>Introduced.</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-comments" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading" id="user-contributed-notes" tabindex="-1"><a href="#user-contributed-notes">User Contributed Notes</a></h2> <ol class="comment-list"> <li class="comment byuser comment-author-codex odd alt thread-odd thread-alt depth-1" data-comment-id="759" id="comment-759">
<article class="comment-body" id="div-comment-759">
<a class="screen-reader-text" href="#comment-content-759">Skip to note 4 content</a>

<!-- .comment-metadata -->
<div class="wporg-has-embedded-code comment-content" id="comment-content-759">
<p><strong>Examples</strong><br/>
If you have a function called <code>myplugin_deactivate()</code> in the main plugin file at either</p>
<p><em>wp-content/plugins/myplugin.php</em> or<br/>
<em>wp-content/plugins/myplugin/myplugin.php</em><br/>
use this code:</p>
<pre class="wp-block-code"><code class="language-php" lang="php">register_deactivation_hook( __FILE__, 'myplugin_deactivate' );</code></pre>
<p>This will call the <code>myplugin_deactivate()</code> function on deactivation of the plugin.</p>
</div><!-- .comment-content -->
<section class="wporg-has-embedded-code feedback hide-if-js" data-comment-count="0" id="feedback-759">
</section><!-- .feedback -->

</article><!-- .comment-body -->
</li>
<li class="comment byuser comment-author-dejanmarkovic even thread-even depth-1" data-comment-id="5628" id="comment-5628">
<article class="comment-body" id="div-comment-5628">
<a class="screen-reader-text" href="#comment-content-5628">Skip to note 5 content</a>

<!-- .comment-metadata -->
<div class="wporg-has-embedded-code comment-content" id="comment-content-5628">
<p>If you are using a namespace in the main plugin file<br/>
namespace MYNAMESAPCE;</p>
<p>you will need to use the __NAMESPACE__ keyword in your code for register_deactivation_hook.<br/>
<code>register_deactivation_hook( __FILE__  ,  __NAMESPACE__  . '\deactivate_plugin' );</code></p>
<p>Otherwise, the code will be unable to find the function deactivate_plugin() and will produce a warning:<br/>
<em>PHP Warning:  call_user_func_array() expects parameter 1 to be a valid callback, function ‘deactivate_plugin’ not found.</em></p>
</div><!-- .comment-content -->
<section class="wporg-has-embedded-code feedback hide-if-js" data-comment-count="0" id="feedback-5628">
</section><!-- .feedback -->

</article><!-- .comment-body -->
</li>
<li class="comment byuser comment-author-ravanh odd alt thread-odd thread-alt depth-1" data-comment-id="6971" id="comment-6971">
<article class="comment-body" id="div-comment-6971">
<a class="screen-reader-text" href="#comment-content-6971">Skip to note 6 content</a>

<!-- .comment-metadata -->
<div class="wporg-has-embedded-code comment-content" id="comment-content-6971">
<p>It is important to note that despite deactivation and uninstall hooks being available since WP 2.0 and 2.7 respectively, there are still a lot of plugins around that do not properly clean up after themselves, cluttering the database with useless data.</p>
<p>A useful difference between <code>register_deactivation_hook</code> and both <code>register_uninstall_hook</code> and <code>uninstall.php</code> is that our deactivation hook callback is run when the plugin <em><strong>is still active</strong></em>. This means this is the last opportunity to run code that is integrally part of the plugin, without having to purposely load specific parts of the plugin or write very large uninstall routines.</p>
<p>So preparing a plugin for a clean uninstall, you might need both these tools: (1) the deactivation action for complicated plugin-specific tasks that need plugin internals, for example removing metadata or transients named variably on user settings and (2) the uninstall action (or better: uninstall.php) to run broader / less complicated tasks like removing a known list of options with <code>delete_option()</code>, removing plugin specific database tables or (cache) files.</p>
<p>An example code of an deactivation callback using a plugin internal method, prepared for both regular and network deactivation:</p>
<pre class="wp-block-code"><code class="language-php line-numbers" lang="php">register_deactivation_hook( __FILE__, array( 'MyPlugin', 'deactivate' ) );

class MyPlugin {

	// ...

	/**
	 * Clear plugin data that might be hard to find without the plugin being active.
	 *
	 * @since x.x
	 */
	public static function cleanup() {
		// ...
	}

	/**
	 * Plugin deactivation.
	 *
	 * @since x.x
	 *
	 * @param bool $network_deactivating Whether the plugin is network deactivated or not.
	 */
	public static function deactivate( $network_deactivating = false ) {
		if ( $network_deactivating &amp;&amp; ! wp_is_large_network() ) {
			$_ids = get_sites(
				array(
					'fields' =&gt; 'ids',
					'number' =&gt; -1,
				)
			);

			foreach ( $_ids as $_id ) {
				switch_to_blog( $_id );

				self::cleanup();

				restore_current_blog();
			}
		} else {
			self::cleanup();
		}
	}
}</code></pre>
<p>Note: one specific problem occurs when your plugin has custom rewrite rules and you need to do revert those on deactivation. A simple <code>flush_rewrite_rules()</code> will not work here, due exactly to the fact that the plugin <strong><em>is still active</em></strong>. You’ll need to take care to undo all plugin rewrite rules added with <code>add_rewrite_rule()</code> before flushing but sadly, a simple function like <code>remove_rewrite_rule()</code> does not exist (yet?)…</p>
</div><!-- .comment-content -->
<section class="wporg-has-embedded-code feedback hide-if-js" data-comment-count="0" id="feedback-6971">
</section><!-- .feedback -->

</article><!-- .comment-body -->
</li>
</ol></section>
</div></div>
    </div>
<footer class="text-center mt-10 py-5">
    <p class="text-sm"><a href="https://notmatt.press">NotMattPress</a>.</p>
</footer>
</body>
</html>
