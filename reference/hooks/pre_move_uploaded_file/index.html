
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled Page</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.5/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: white;
            color: black;
            font-family: 'Quicksand', 'Open Sans', 'Helvetica', 'Arial', san-serif;
        }
        a, h1, h2, h3, h4, h5, h6 {
            color: #0073aa;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }
        .has-small-font-size.is-link-to-top {
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
        .entry-content {
            position:relative;
        }
        .entry-content img {
            max-width: 100%;
        }
    </style>
</head>
<body>
<div class='container'>
    
    <div class="page-metadata" data-published="" data-last-updated=""></div>
    
    <div aria-label="Breadcrumbs" class="wp-block-wporg-site-breadcrumbs has-small-font-size" role="navigation"><div class="wporg-site-breadcrumbs__wrapper"><span><a href="https://developer.wordpress.org">Home</a></span><span><a href="https://developer.wordpress.org/reference/">Reference</a></span><span><a href="https://developer.wordpress.org/reference/hooks/">Hooks</a></span><span class="is-current-page">pre_move_uploaded_file</span></div></div>  <!-- Full breadcrumbs HTML -->
    <h1>pre_move_uploaded_file</h1>
    <h1 class="wp-block-wporg-code-reference-title" style="margin-bottom:40px;"><span class="hook-func">apply_filters</span>( ‘pre_move_uploaded_file’,  <nobr><span class="arg-type">mixed</span> <span class="arg-name">$move_new_file</span></nobr>,  <nobr><span class="arg-type">array</span> <span class="arg-name">$file</span></nobr>,  <nobr><span class="arg-type">string</span> <span class="arg-name">$new_file</span></nobr>,  <nobr><span class="arg-type">string</span> <span class="arg-name">$type</span></nobr> )</h1>
    
    <div class="content"><div class="entry-content wp-block-post-content is-layout-flow wp-container-core-post-content-is-layout-1 wp-block-post-content-is-layout-flow">
<section class="wp-block-wporg-code-reference-summary"><p>Filters whether to short-circuit moving the uploaded file after passing all checks.</p>
</section>
<section class="wp-block-wporg-code-reference-description"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="description" tabindex="-1"><a href="#description">Description</a></h2> <p>If a non-null value is returned from the filter, moving the file and any related error reporting will be completely skipped.</p>
</section>
<section class="wp-block-wporg-code-reference-parameters"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="parameters" tabindex="-1"><a href="#parameters">Parameters</a></h2> <dl><dt><code>$move_new_file</code><span class="type"><span class="mixed">mixed</span></span></dt><dd><div class="desc"><span class="description">If null (default) move the file after the upload.</span></div></dd><dt><code>$file</code><span class="type"><span class="array">array</span></span></dt><dd><div class="desc"><span class="description">Reference to a single element from <code>$_FILES</code>.<br/>
<ul class="param-hash"><li><code>name</code> <span class="type">string</span><div class="desc">The original name of the file on the client machine.</div></li>
<li><code>type</code> <span class="type">string</span><div class="desc">The mime type of the file, if the browser provided this information.</div></li>
<li><code>tmp_name</code> <span class="type">string</span><div class="desc">The temporary filename of the file in which the uploaded file was stored on the server.</div></li>
<li><code>size</code> <span class="type">int</span><div class="desc">The size, in bytes, of the uploaded file.</div></li>
<li><code>error</code> <span class="type">int</span><div class="desc">The error code associated with this file upload.</div></li>
</ul>
</span></div></dd><dt><code>$new_file</code><span class="type"><span class="string">string</span></span></dt><dd><div class="desc"><span class="description">Filename of the newly-uploaded file.</span></div></dd><dt><code>$type</code><span class="type"><span class="string">string</span></span></dt><dd><div class="desc"><span class="description">Mime type of the newly-uploaded file.</span></div></dd></dl></section>
<section class="wp-block-wporg-code-reference-source"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="source" tabindex="-1"><a href="#source">Source</a></h2> <pre aria-label="Function source code" class="wp-block-code" data-start="1010"><code class="language-php line-numbers" id="wporg-source-code" lang="php">$move_new_file = apply_filters( 'pre_move_uploaded_file', null, $file, $new_file, $type );
</code></pre><p class="wporg-dot-link-list"><a href="https://developer.notmatt.press/reference/files/wp-admin/includes/file.php/">View all references</a> <a href="https://core.trac.wordpress.org/browser/tags/6.7/src/wp-admin/includes/file.php#L1010">View on Trac</a> <a href="https://github.com/WordPress/wordpress-develop/blob/6.7/src/wp-admin/includes/file.php#L1010-L1010">View on GitHub</a></p></section>
<section class="wp-block-wporg-code-reference-related" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="related" tabindex="-1"><a href="#related">Related</a></h2> <section class="wp-block-wporg-code-table" id="used-by" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Used by</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/functions/_wp_handle_upload/">_wp_handle_upload()</a><code>wp-admin/includes/file.php</code></td><td><p>Handles PHP uploads in WordPress.</p>
</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-changelog"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="changelog" tabindex="-1"><a href="#changelog">Changelog</a></h2> <section class="wp-block-wporg-code-table" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Version</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/since/4.9.0/">4.9.0</a></td><td>Introduced.</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-comments" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading" id="user-contributed-notes" tabindex="-1"><a href="#user-contributed-notes">User Contributed Notes</a></h2> <ol class="comment-list"> <li class="comment byuser comment-author-aurovrata odd alt thread-odd thread-alt depth-1" data-comment-id="6717" id="comment-6717">
<article class="comment-body" id="div-comment-6717">
<a class="screen-reader-text" href="#comment-content-6717">Skip to note 2 content</a>

<!-- .comment-metadata -->
<div class="wporg-has-embedded-code comment-content" id="comment-content-6717">
<p>There is an interesting <a href="https://wordpress.org/support/topic/purpose-of-pre_move_uploaded_file-hook/" rel="nofollow ugc">question</a> on this filter in the support forum with a rather complicated reply, however, I have to use this for a slightly different problem.</p>
<p>I normally use the function <a href="https://developer.notmatt.press/reference/functions/media_handle_sideload/" rel="ugc"><code>media_handle_sideload()</code></a> to move a file into the wp uploads fodler and save it as a media attachment post, which works quite nicely.  </p>
<p>However, recently I had to copy a file (rather than move it), in my plugin extension as the original plugin still needed to have access to the original file location (a temporary folder on the fs), and unfortunately there is no way to get the <code>media_handle_sideload()</code> to copy rather than move a file.</p>
<p>This is where this filter comes in handy.  The <code>media_handle_sideload()</code> makes use of the <a href="https://developer.notmatt.press/reference/functions/wp_handle_sideload/" rel="ugc"><code>wp_handle_sideload()</code></a>, which in turns calls the <code>_wp_handle_upload()</code> function, within which the <code>pre_move_uploaded_file</code> filter is applied.</p>
<p>The filter can be used to switch off the actual moving of the file while retaining all the goodness of validation that the function handles, allowing one to handle the actual file handling, copying it instead of moving it in my case.  This is how I used it,</p>
<pre class="wp-block-code"><code class="language-php line-numbers" lang="php">// first step is to identify the filename and path you want to copy. 
$file_arr = array(
	'name'     =&gt; $filename, //something like my-photo.jpg
	'tmp_name' =&gt; $path, //something like /..../wp-content/uploads/cf7-uploads/tmp/my-photo.jpg
);

// next use a unique action handle to identify your file process from others handled by WP core/plugins.
$action = 'wpdocs_file_copy';

// this allows to identify your file action with the filter applied at the start of _wp_handle_upload().
// register your file handling process with an anonymous function.
add_filter( "{$action}_prefilter", function( $file ) {
	// next we hook the filter to cancel the file move.
	add_filter( 'pre_move_uploaded_file', function( $move, $file, $new_file ) {
	
		// now you copy your file, knowing that the $new_file path has been validated by WP.
		$move = @copy( $file['tmp_name'], $new_file );
		
		if ( false === $move &amp;&amp; WP_DEBUG ) {
			trigger_error( ... ); // handle the error (optional). 
		}
		
		return $move; // either false or true, but not null will cancel the file move.
	}, 10, 3 ); // pre_move filter
	
	return $file;
} ); // filter

// now you fire the actually file moving process which will validate the new location of the file on the fs and trigger the above filter.
$new_file_arr = wp_handle_sideload( $file_arr,
	array(
		'action'    =&gt; $action, // the action defined above.
		'test_form' =&gt; false, // in this case the file I am copying is not coming from the $_FILES submission and so I don't need the extra validation. 
	),
	current_time( 'mysql' ) // timestamp.
);

if ( isset( $new_file_arr['error'] ) ) { //in case there was an error.
	// handle the error (optional)
} else {
	$url      = $new_file_arr['url'];
	$type     = $new_file_arr['type'];
	$new_file = $new_file_arr['file'];
}
// you can then go on to create an attachment post and link it to a parent post if need be.</code></pre>
<p>Note, the above only copies the file to the <code>wp-content/uploads/&lt;year&gt;/&lt;month&gt;/</code> folder structure, but does not actually create an attachment post (required to see your file in the Media section of the dashboard), nor links it to a parent post (eg as a featured/thumbnail image).  If you need to see how to do this I suggest you take a look at the process used in the <a href="https://developer.notmatt.press/reference/functions/media_handle_sideload/" rel="ugc"><code>media_handle_sideload()</code></a> function.</p>
</div><!-- .comment-content -->
<section class="wporg-has-embedded-code feedback hide-if-js" data-comment-count="0" id="feedback-6717">
</section><!-- .feedback -->

</article><!-- .comment-body -->
</li>
</ol></section>
</div></div>
    </div>
<footer class="text-center mt-10 py-5">
    <p class="text-sm"><a href="https://notmatt.press">NotMattPress</a>.</p>
</footer>
</body>
</html>
