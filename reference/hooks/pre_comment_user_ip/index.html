
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untitled Page</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.5/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: white;
            color: black;
            font-family: 'Quicksand', 'Open Sans', 'Helvetica', 'Arial', san-serif;
        }
        a, h1, h2, h3, h4, h5, h6 {
            color: #0073aa;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }
        .has-small-font-size.is-link-to-top {
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
        .entry-content {
            position:relative;
        }
        .entry-content img {
            max-width: 100%;
        }
    </style>
</head>
<body>
<div class='container'>
    
    <div class="page-metadata" data-published="" data-last-updated=""></div>
    
    <div aria-label="Breadcrumbs" class="wp-block-wporg-site-breadcrumbs has-small-font-size" role="navigation"><div class="wporg-site-breadcrumbs__wrapper"><span><a href="https://developer.wordpress.org">Home</a></span><span><a href="https://developer.wordpress.org/reference/">Reference</a></span><span><a href="https://developer.wordpress.org/reference/hooks/">Hooks</a></span><span class="is-current-page">pre_comment_user_ip</span></div></div>  <!-- Full breadcrumbs HTML -->
    <h1>pre_comment_user_ip</h1>
    <h1 class="wp-block-wporg-code-reference-title" style="margin-bottom:40px;"><span class="hook-func">apply_filters</span>( ‘pre_comment_user_ip’,  <nobr><span class="arg-type">string</span> <span class="arg-name">$comment_author_ip</span></nobr> )</h1>
    
    <div class="content"><div class="entry-content wp-block-post-content is-layout-flow wp-container-core-post-content-is-layout-1 wp-block-post-content-is-layout-flow">
<section class="wp-block-wporg-code-reference-summary"><p>Filters the comment author’s IP address before it is set.</p>
</section>
<section class="wp-block-wporg-code-reference-parameters"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="parameters" tabindex="-1"><a href="#parameters">Parameters</a></h2> <dl><dt><code>$comment_author_ip</code><span class="type"><span class="string">string</span></span></dt><dd><div class="desc"><span class="description">The comment author’s IP address.</span></div></dd></dl></section>
<section class="wporg-has-embedded-code wp-block-wporg-code-reference-explanation"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="more-information" tabindex="-1"><a href="#more-information">More Information</a></h2>
<p>With this filter, we can change the comment author’s IP before it’s recorded. Example use case can be when a client submits a comment through a proxy server.</p>
<p>The general format of the header is:<br/>
<code>X-Forwarded-For: client1, proxy1, proxy2</code></p>
<p>where the value is a comma+space separated list of IP addresses, the left-most being the original client, and each successive proxy that passed the request adding the IP address where it received the request from. In this example, the request goes through the IPs: client1 -&gt; proxy1 -&gt; proxy2 -&gt; proxy3. Proxy3 is not shown in the <code>X-Forwarded-For</code> header here and appears as the remote address of the request.</p>
<p>Since it is easy to forge an <code>X-Forwarded-For</code> header, the given information should be used with care.</p>
<p><code>X-Forwarded-For</code>, <code>X-Forwarded-By</code>, and <code>X-Forwarded-Proto</code> are non-standard header fields and in increasing cases, have been superseded by the standard <code>Forwarded</code> header defined in RFC 7239. Example of a <code>Forwarded</code> header:<br/>
<code>Forwarded: for=192.0.2.60;proto=http;by=203.0.113.43</code></p>
</section>
<section class="wp-block-wporg-code-reference-source"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="source" tabindex="-1"><a href="#source">Source</a></h2> <pre aria-label="Function source code" class="wp-block-code" data-start="2151"><code class="language-php line-numbers" id="wporg-source-code" lang="php">$commentdata['comment_author_IP'] = apply_filters( 'pre_comment_user_ip', $commentdata['comment_author_IP'] );
</code></pre><p class="wporg-dot-link-list"><a href="https://developer.notmatt.press/reference/files/wp-includes/comment.php/">View all references</a> <a href="https://core.trac.wordpress.org/browser/tags/6.7/src/wp-includes/comment.php#L2151">View on Trac</a> <a href="https://github.com/WordPress/wordpress-develop/blob/6.7/src/wp-includes/comment.php#L2151-L2151">View on GitHub</a></p></section>
<section class="wp-block-wporg-code-reference-related" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="related" tabindex="-1"><a href="#related">Related</a></h2> <section class="wp-block-wporg-code-table" id="used-by" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Used by</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/functions/wp_filter_comment/">wp_filter_comment()</a><code>wp-includes/comment.php</code></td><td><p>Filters and sanitizes comment data.</p>
</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-changelog"><h2 class="is-toc-heading wp-block-heading has-heading-5-font-size" id="changelog" tabindex="-1"><a href="#changelog">Changelog</a></h2> <section class="wp-block-wporg-code-table" style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table"><table><thead><tr><th scope="col">Version</th><th scope="col">Description</th></tr></thead><tbody><tr class=""><td><a href="https://developer.notmatt.press/reference/since/1.5.0/">1.5.0</a></td><td>Introduced.</td></tr></tbody></table></figure></section> </section>
<section class="wp-block-wporg-code-reference-comments" data-nosnippet="true"><h2 class="is-toc-heading wp-block-heading" id="user-contributed-notes" tabindex="-1"><a href="#user-contributed-notes">User Contributed Notes</a></h2> <ol class="comment-list"> <li class="comment byuser comment-author-stevenlinx even thread-odd thread-alt depth-1" data-comment-id="4830" id="comment-4830">
<article class="comment-body" id="div-comment-4830">
<a class="screen-reader-text" href="#comment-content-4830">Skip to note 2 content</a>

<!-- .comment-metadata -->
<div class="wporg-has-embedded-code comment-content" id="comment-content-4830">
<p>Example Migrated from Codex:</p>
<p>Use the left-most IP (the original client) in the <code>X-Forwarded-For</code> header as the comment author’s IP address.</p>
<p>Note: You may need to adjust the example below for the standard <code>Forwarded</code> header, which supersedes the non-standard <code>X-Forwarded-For</code> header.</p>
<pre class="wp-block-code"><code class="language-php line-numbers" lang="php">add_filter( 'pre_comment_user_ip', 'auto_reverse_proxy_pre_comment_user_ip');

function auto_reverse_proxy_pre_comment_user_ip()
{    
	$REMOTE_ADDR = $_SERVER['REMOTE_ADDR'];

	if (!empty($_SERVER['X_FORWARDED_FOR'])) {
		$X_FORWARDED_FOR = explode(',', $_SERVER['X_FORWARDED_FOR']);
		if (!empty($X_FORWARDED_FOR)) {
			$REMOTE_ADDR = trim($X_FORWARDED_FOR[0]);
		}
	}

	/*
	* Some PHP environments will use the $_SERVER['HTTP_X_FORWARDED_FOR'] 
	* variable to capture visitor address information.
	*/
	elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
		$HTTP_X_FORWARDED_FOR= explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
		if (!empty($HTTP_X_FORWARDED_FOR)) {
			$REMOTE_ADDR = trim($HTTP_X_FORWARDED_FOR[0]);
		}
	}

	return preg_replace('/[^0-9a-f:\., ]/si', '', $REMOTE_ADDR);
}</code></pre>
</div><!-- .comment-content -->
<section class="wporg-has-embedded-code feedback hide-if-js" data-comment-count="1" id="feedback-4830">
<ul class="children">
<li class="comment byuser comment-author-lxtx odd alt depth-2" data-comment-id="5494" id="comment-5494">
<article class="comment-body" id="div-comment-5494">
<div class="wporg-has-embedded-code comment-content" id="comment-content-5494">
<div>After using the example, the ‘comment_author_IP’ will be changed to current admin’s IP after editing the comment from wp-admin.     Pls go to this link for details: <a href="https://core.trac.wordpress.org/ticket/54482?nocache" rel="nofollow ugc">https://core.trac.wordpress.org/ticket/54482?nocache</a></div>
<div><a class="url" href="https://profiles.wordpress.org/lxtx/" rel="external nofollow">龙笑天</a> <a class="comment-date" href="https://developer.notmatt.press/reference/hooks/pre_comment_user_ip/#comment-5494"><time datetime="2021-11-21T10:26:39+00:00">3 years ago</time></a></div>
</div><!-- .comment-content -->
</article>
</li>
</ul>
</section><!-- .feedback -->

</article><!-- .comment-body -->
</li>
</ol></section>
</div></div>
    </div>
<footer class="text-center mt-10 py-5">
    <p class="text-sm"><a href="https://notmatt.press">NotMattPress</a>.</p>
</footer>
</body>
</html>
